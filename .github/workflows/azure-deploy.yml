name: Deploy to Azure Container Apps

# Manual deployment only - no automatic triggers on commits
on:
  workflow_dispatch:

env:
  # Azure resource configuration
  RESOURCE_GROUP: RG-GBLI-AI-Risk-Insights
  CONTAINER_APP_NAME: je-tavily-adapter
  CONTAINER_ENV_NAME: je-tavily-env
  LOCATION: westeurope
  
  # Container images
  MAIN_IMAGE: jeconsulting/searxng-docker-tavily-adapter:latest
  REDIS_IMAGE: valkey/valkey:8-alpine
  SEARXNG_IMAGE: searxng/searxng:latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Log in to Azure using service principal credentials from GitHub secrets
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # Check if Container Apps environment exists, create if needed
      - name: Create Container Apps Environment if needed
        run: |
          # Check if environment exists
          if ! az containerapp env show \
            --name ${{ env.CONTAINER_ENV_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --output none 2>/dev/null; then
            
            echo "Creating Container Apps environment..."
            az containerapp env create \
              --name ${{ env.CONTAINER_ENV_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --location ${{ env.LOCATION }}
          else
            echo "Container Apps environment already exists"
          fi
      
      # Deploy or update the container app with sidecars using CLI commands
      - name: Deploy Container App with Sidecars
        run: |
          # Base64 encode the config to safely pass as environment variable
          # This avoids issues with multiline content and special characters
          CONFIG_B64=$(echo "${{ secrets.CONFIG_YAML }}" | base64 -w 0 || echo "${{ secrets.CONFIG_YAML }}" | base64)
          SEARXNG_SECRET="${{ secrets.SEARXNG_SECRET_KEY }}"
          
          # Check if container app exists
          if az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --output none 2>/dev/null; then
            
            echo "Container app exists - deleting and recreating to update sidecars configuration..."
            az containerapp delete \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --yes
            
            echo "Waiting for deletion to complete..."
            sleep 10
          fi
          
          echo "Creating container app with main container..."
          
          # Create the container app with main container
          # Include Docker Hub registry credentials for pulling the image
          az containerapp create \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_ENV_NAME }} \
            --image ${{ env.MAIN_IMAGE }} \
            --target-port 8000 \
            --ingress external \
            --cpu 0.5 \
            --memory 1Gi \
            --min-replicas 1 \
            --max-replicas 3 \
            --registry-server docker.io \
            --registry-username ${{ secrets.DOCKER_USER }} \
            --registry-password ${{ secrets.DOCKER_PASSWORD }} \
            --env-vars "CONFIG_YAML=${{ secrets.CONFIG_YAML }}"
          
          echo "Main container created. Adding sidecars..."
          
          # Add Redis sidecar
          echo "Adding Redis sidecar..."
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --container-name redis \
            --image ${{ env.REDIS_IMAGE }} \
            --cpu 0.25 \
            --memory 0.5Gi \
            --args "valkey-server" "--save" "30" "1" "--loglevel" "warning"
          
          # Add SearXNG sidecar
          echo "Adding SearXNG sidecar..."
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --container-name searxng \
            --image ${{ env.SEARXNG_IMAGE }} \
            --cpu 0.5 \
            --memory 1Gi \
            --set-env-vars \
              "BIND_ADDRESS=[::]:8080" \
              "SEARXNG_BASE_URL=http://localhost:8080/" \
              "SEARXNG_SECRET=$SEARXNG_SECRET"
          
          echo "Deployment completed!"
      
      # Display the deployed application URL
      - name: Get Application URL
        id: get_url
        run: |
          FQDN=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          
          echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "Deployment completed successfully!"
          echo "=========================================="
          echo "Application URL: https://$FQDN"
          echo "Health check: https://$FQDN/health"
          echo "=========================================="
          echo ""
          echo "Test with:"
          echo "curl -X POST https://$FQDN/search -H 'Content-Type: application/json' -d '{\"query\":\"test\"}'"
      
      # Wait for application to be fully ready and verify health
      - name: Verify Application Health
        run: |
          FQDN="${{ steps.get_url.outputs.fqdn }}"
          HEALTH_URL="https://$FQDN/health"
          
          echo "=========================================="
          echo "Verifying application health..."
          echo "=========================================="
          echo "Waiting for application to be ready (max 2 minutes)..."
          
          # Wait up to 120 seconds for the app to be healthy
          MAX_ATTEMPTS=24
          ATTEMPT=0
          SLEEP_TIME=5
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Try to call the health endpoint
            HTTP_CODE=$(curl -s -o /tmp/health_response.json -w "%{http_code}" "$HEALTH_URL" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check PASSED!"
              echo "Response:"
              cat /tmp/health_response.json
              echo ""
              echo "=========================================="
              echo "üéâ Deployment verified successfully!"
              echo "=========================================="
              echo "Application is healthy and ready to use"
              echo "URL: https://$FQDN"
              exit 0
            else
              echo "‚è≥ Health check returned HTTP $HTTP_CODE, waiting ${SLEEP_TIME}s..."
              sleep $SLEEP_TIME
            fi
          done
          
          # If we get here, health check failed
          echo "=========================================="
          echo "‚ùå Health check FAILED!"
          echo "=========================================="
          echo "Application did not become healthy within 2 minutes"
          echo "Please check the logs:"
          echo "az containerapp logs show -n ${{ env.CONTAINER_APP_NAME }} -g ${{ env.RESOURCE_GROUP }} --tail 100"
          exit 1

